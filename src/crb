#!/bin/bash
# Claude Remote Bridge CLI
# Quick commands for managing the bridge

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INBOX="${HOME}/.claude_inbox"
OUTBOX="${HOME}/.claude_outbox"
PID_FILE="${HOME}/.claude_bridge.pid"
LOG_FILE="${HOME}/.claude_bridge.log"

usage() {
    cat << EOF
Claude Remote Bridge - Remote communication with Claude Code

Usage: crb <command> [options]

Commands:
    start <topic>     Start the bridge daemon
    stop              Stop the bridge daemon
    status            Show bridge status
    inbox             Check inbox for messages
    send <message>    Send a message to Claude
    reply <message>   Alias for send
    clear             Clear inbox
    logs              Show bridge logs
    hook              Install Claude Code auto-check hook
    unhook            Remove Claude Code hook
    help              Show this help

Examples:
    crb start my-claude-topic
    crb hook                      # Install auto-check hook
    crb inbox
    crb send "proceed with the task"
    crb stop

Environment:
    CLAUDE_BRIDGE_TOPIC    Default topic if not specified
EOF
}

start_bridge() {
    local topic="${1:-$CLAUDE_BRIDGE_TOPIC}"

    if [ -z "$topic" ]; then
        echo "Error: Topic required. Usage: crb start <topic>"
        exit 1
    fi

    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo "Bridge already running (PID: $pid)"
            exit 1
        fi
    fi

    echo "Starting bridge for topic: $topic"
    python3 "${SCRIPT_DIR}/bridge.py" --topic "$topic" --daemon

    sleep 1
    if [ -f "$PID_FILE" ]; then
        echo "Bridge started (PID: $(cat $PID_FILE))"
    else
        echo "Failed to start bridge. Check logs: $LOG_FILE"
        exit 1
    fi
}

stop_bridge() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid"
            rm -f "$PID_FILE"
            echo "Bridge stopped"
        else
            rm -f "$PID_FILE"
            echo "Bridge not running (stale PID file removed)"
        fi
    else
        echo "Bridge not running"
    fi
}

show_status() {
    echo "=== Claude Remote Bridge Status ==="
    echo

    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo "Bridge: RUNNING (PID: $pid)"
        else
            echo "Bridge: STOPPED (stale PID)"
        fi
    else
        echo "Bridge: STOPPED"
    fi

    echo
    echo "Inbox: $INBOX"
    if [ -f "$INBOX" ]; then
        local total=$(wc -l < "$INBOX" | tr -d ' ')
        local unread=$(grep -c '"read": false' "$INBOX" 2>/dev/null || echo 0)
        echo "  Messages: $total total, $unread unread"
    else
        echo "  Messages: 0"
    fi

    echo
    echo "Outbox: $OUTBOX"
    if [ -f "$OUTBOX" ]; then
        local pending=$(wc -l < "$OUTBOX" | tr -d ' ')
        echo "  Pending: $pending"
    else
        echo "  Pending: 0"
    fi
}

check_inbox() {
    python3 "${SCRIPT_DIR}/claude_integration.py"
}

send_message() {
    local message="$*"

    if [ -z "$message" ]; then
        echo "Error: Message required. Usage: crb send <message>"
        exit 1
    fi

    python3 "${SCRIPT_DIR}/claude_integration.py" reply "$message"
}

clear_inbox() {
    rm -f "$INBOX"
    echo "Inbox cleared"
}

show_logs() {
    if [ -f "$LOG_FILE" ]; then
        tail -50 "$LOG_FILE"
    else
        echo "No logs found"
    fi
}

# Main
case "${1:-help}" in
    start)
        shift
        start_bridge "$@"
        ;;
    stop)
        stop_bridge
        ;;
    status)
        show_status
        ;;
    inbox|check)
        check_inbox
        ;;
    send|reply)
        shift
        send_message "$@"
        ;;
    clear)
        clear_inbox
        ;;
    logs)
        show_logs
        ;;
    hook)
        python3 "${SCRIPT_DIR}/install_hook.py"
        ;;
    unhook)
        python3 "${SCRIPT_DIR}/install_hook.py" --uninstall
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
